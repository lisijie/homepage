---
layout: post
title: TCP连接的建立和断开过程
category: 技术
keywords: tcp
date: 2015-09-29
author: lisijie
---

TCP连接的建立需要经过3次报文交换，也称为3次握手。断开连接需要经过4次报文交换，称为4次握手。TCP的握手发生在内核，对应用程序是透明的，应用程序只需要调用对应的Socket API即可。

### 建立连接

建立连接的3次握手是这样的：

1. 客户端说：服务器，我请求跟你建立连接，收到请回答。(SYN)
2. 服务器说：客户端，请求已收到，我同意跟你连接，收到请回答。(SYN+ACK)
3. 客户端说：服务器，我已收到。(ACK)

SYN和ACK可以称为同步和应答，它们分别对应TCP头部的一个标识位，因此可以在一个包同时包含两种状态。经过3次报文交换之后，内核将已建立的连接交给应用程序，客户端和服务端就可以进行通信了。

### 断开连接

断开连接通常是客户端主动发起的，正常断开连接的4次握手过程是这样的：

1. 客户端说：服务器，我的数据发完了，准备断开连接，收到请回答。(FIN)
2. 服务器说：客户端，消息收到，可以断开了。(ACK)
3. 服务器又说：客户端，我给你的数据也发完了，准备断开连接，收到请回答。(FIN)
4. 客户端说：服务器，消息收到，可以断开了。(ACK)

FIN是TCP头部的另一个标识位，表示发送端完成数据发送。由于TCP是全双工的连接，两端可以同时进行数据发送。可以看成它们之间建立了两条通道，一条是客户端发往服务器，另一条是服务器发往客户端。因此断开也需要分别断开。单独关闭一条也是允许的。

### TCP状态

下图为[RFC 793](http://www.ietf.org/rfc/rfc793.txt)描述的TCP连接建立和断开过程中的各种状态号。使用netstat命令可以查看系统中的网络连接状态。

![](/static/images/tcp-states.png)

下面对各个状态进行简单的说明。

- LISTEN - 表示当前程序正在监听某个端口时。
- SYN\_SENT - 客户端发起第1次握手后，连接状态为SYN_SENT，等待服务端内核进行应答，如果服务端来不及处理（例如服务端的backlog队列已满）就可以看到这种状态的连接。
- SYN\_RCVD - 服务端收到第1次握手后，进入SYN_RCVD状态，并回复一个SYN+ACK（第2次握手），再等待对方确认。
- ESTABLISHED - 表示连接处于正常状态，可以进行数据传送。客户端收到服务器回复的SYN+ACK包后，对服务端的SYN单独回复（第3次握手），连接建立完成，进入ESTABLISHED状态。服务端程序收到第3次握手包后，也进入ESTABLISHED状态。

