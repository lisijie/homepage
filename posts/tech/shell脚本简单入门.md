---
layout: post
title: Shell脚本简单入门
category: 技术
keywords: shell
date: 2016-03-16
author: 李思杰
---

最近写了比较多的shell脚本，因为语法比较特殊，不经常写的话容易忘记。这里对bash shell的语法做下总结，当做备忘。

首先看一个简单的示例脚本：

	#!/bin/bash
	#----------------------
	# 登录到远程服务器
	# @author lisijie
	# ---------------------
	
	ip=$1
	user=$2
	defUser="www"
	
	while [[ "$ip" == "" ]]; do
		read -p "请输入登录服务器(IP [user])：" ip user
	done

	if [ -z "$user" ]; then
		user=$defUser
	fi
	
	ssh -p 22 ${user}@${ip}

把以上脚本保存为 `go`，并赋予可执行权限，就可以使用  `./go 192.168.1.2` 登录到一台远程服务器，而不用去敲完整的命令。

有些时候会在一些脚本中看到开头使用了 `set -e` 语句，这是告诉bash如果任何语句的执行结果不是true则应该退出，这样的好处是防止错误像滚雪球般变大导致一个致命的错误。

#### 1、注释

以井号`#`开头的是脚本注释，第一行的 `#!/bin/bash` 比较特殊，用来指明解析该脚本的程序，这里表示这是一个bash脚本。把脚本加上可执行权限后，直接执行脚本时，shell会检查第一行的声明，并调用相应的程序来执行该脚本。如果没有定义，就没法直接执行，因为shell不知道这是一个什么脚本，该用什么程序来解析它。linux下面有多种shell，不同的shell语法可能会有区别，常用的是bash，所以一般使用 `#!/bin/bash`。对于PHP脚本，我们也可以在前面加上PHP的解析器路径来声明这是一个PHP脚本，然后直接执行，如 `#!/usr/bin/php`。

**注意：** #!/bin/bash 后面的换行符必须是linux标准的换行符`\n`，换成`\r`或`\r\n`都会导致脚本无法直接执行。

#### 2、变量

变量名跟其他语言差不多，由大小写字母数字和下划线组成，并且不能以数字开头。定义变量使用 `变量名=变量值` 格式，需要特别注意的是，`=` 号两边不能有空格。shell的变量值默认都是字符串，所以不能直接进行数学运算。

下面是常用的例子：

	# 定义变量var1，值为字符串hello
	var1="hello"

	# 定义变量var2，值为字符串2016
	var2=2016

	# 定义变量var3，值为 var2 - 16
	var3=$((var2 - 16))

	# 定义变量var3，值为 "ls -l | wc -l" 这条命令的执行结果，命令使用反引号括起来，命令会先执行，再把结果赋给变量。
	var4=`ls -l | wc -l`
	
	# 命令替换，和用反引号的效果相同
	var5=$(ls -l | wc -l) 

要读取一个变量的值，需要在前面加上`$`符号，为了避免跟其它字符在一起产生混淆，可以在变量名加上一对大括号`{}`，如：

	echo $var1
	echo ${var1}world
	echo "${var1} ${var2}"
	
**注意：** 放在单引号中的变量不会被解析。如果要在echo输出换行符等特殊字符，需要加上`-e`参数，如：`echo -e "${var1}\n${var2}"`。

**特殊变量：** 

shell中有一些特殊变量，$?、$#、$@、$0、$1、$2、$3... 

 - `$?` 表示上一个命令的退出状态码，值为0-255，0表示正常退出。
 - `$#` 表示传递给脚本的参数数量。
 - `$@` 表示所有参数。
 - `$!` 表示最后一个子shell进程ID。
 - `$$` 表示当前进程ID。
 - `$0` 第0个参数，值为命令名称。
 - $1、$2、$3... 分别表示第1、第2、第3个参数。

#### 3、数学运算

在bash shell使用数学运算方法有2种，但由于bash shell不支持浮点数，所以小数点后面的数会被舍弃。

第一种，使用 `$[  ]` 把表达式括起来 ，例如：

	var1=10
	var2=$[$var1 * 2]
	var3=$[$var1 / 3] # 结果var3=3
	
第二种方式是使用双括号 `(( ))` 把表达式括起来，这种方式需要把赋值写到括号里面：
	
	(( var6 = $var2 ** 3 ))
	(( var6++ ))


一些特殊运算符说明：

| 运算符      | 说明         |
| -----------|-------------|
| var++      | 后自增       |
| var--      | 后自减       |
| ++var      | 先自减       |
| --var      | 先自减       |
| !          | 逻辑非       |
| ~          | 位求反       |
| **         | 幂运算       |
| <<         | 左位移       |
| >>         | 右位移       |
| &          | 按位与       |
| \|         | 按位或       |
| &&         | 逻辑与       |
| \|\|       | 逻辑或       |

#### 4、if语句

if语句跟常用的编程语言有很大不同，基本语法如下：
	
	if 表达式1
	then
		...
	elif 表达式2
	then
		...
	else
		...
	fi
	
为了代码的美观，可以把if和then放在同一行：
	
	if 表达式1 ; then
		...
	elif 表达式2 ; then
		...
	else 
		...
	fi
	
	
条件表达式可以有多种形式，除了直接写命令，还可以用`[ ... ]`、`[[ ... ]]`、`(( ... ))`括起来，比较复杂，下面简述一下：
 
 * 如果表达式没有用括号。bash将表达式当做命令执行（命令的输出也会打印出来），如果命令的退出状态码为0（成功的状态码），则执行then后面的语句，否则执行下一个分支语句。
 
 		if foo ; then
			echo "存在命令foo且执行成功"
		elif cat a.out ; then
			echo "存在文件a.out"
		else
			echo "上面的命令都执行失败"
		fi
 
 * `[ ]` 是bash shell的test命令，括起来的表达式可以做比较运算，例如判断两个变量是否相等，注意，`表达式跟两个括号之间必须留有一个空格`。一对中括号只能用一个条件，如果需要测试多个条件，需要使用`if [ 表达式1 ] && [ 表达式2 ]` 或 `if [ 表达式1 ] || [ 表达式2 ]`这种形式。bash shell中可以进行3类比较：数值比较、字符串比较、文件比较。需要注意的是，bash shell能处理的数只有整数。
 	* 数值比较支持：-eq（等于）、-ge（大于等于）、-gt（大于）、-le（小于等于）、-lt（小于）、-ne（不等于） 6种运算符。例如：
 		
 			var1=10
			var2=11
			if [ $var1 -gt 10 ]; then
				echo "var1大于10"
			fi
			if [ $var2 -gt 10 ] && [ $var2 -lt 15 ]; then
				echo "var2大于10且小于15"
			fi
 	
 	* 字符串比较运算符有 =、!=、>、< 和 -n $var（长度是否非0）、-z $var（长度是否为0）。在测试表达式中，=和==的效果是一样的。这里需要注意的是，由于`>`、`<`是重定向符号，因此在测试表达式中使用需要加上反斜杠`\`进行转义，如：
 		 		
 		 	var1="hello"
			var2="Hello"
			var3=""
			if [ $var1 \> $var2 ]; then
				echo "bash shell的比较根据ASCII码值，因此${var1}大于${var2}"
			fi
			if [ -z "$var3" ]; then
				echo "var3是个空字符串"
			fi
			if [ -z "$var4" ]; then
				echo "var4是个空字符串"
			fi
					
 	* 文件比较支持以下表达式：
 	
		| 表达式           | 说明                              |
		| ----------------|-----------------------------------|
		| -d file         | file 检查file是否是一个目录          |
		| -e file         | 检查file是否存在                    |
		| -f file         | 检查file是否存在且是一个文件          |
		| -r file         | 检查file是否存在且可读               |
		| -s file         | 检查file是否存在且非空               |
		| -w file         | 检查file是否存在且可写               |
		| -x file         | 检查file是否存在且可执行             |
		| -O file         | 检查file是否存在且是当前用户所有       |
		| -G file         | 检查file是否存在且用户组与当前用户相同  |
		| file1 -nt file2 | 检查file1是否比file2新              |
		| file1 -ot file2 | 检查file1是否比file2旧              |

		示例：
		
			dir="/data/htdocs"
			if [ ! -d $dir ]; then
				mkdir -p $dir
				echo "创建目录: ${dir}"
			fi
			
* `(( ))` 括起来的表达式可以做一些高级的数学运算。

* `[[ ]]` 括起来的表达式支持字符串比较的高级特性，如正则表达式。

#### 5、case语句

类似其他编程语言中的switch case语句，用法如下：
	
	case $1 in
	start | run)
		执行start分支;;
	stop)
		执行stop分支;;
	*)
		执行默认分支;;
	esac 
	
说明：

 - 使用 `|` 在一个分支匹配多个值。
 - 每个分支最后必须已两个分号 `;;` 结束。
 - `*` 匹配所有值，可以用来实现default分支的效果。

#### 6、for语句

**for in语句：**

for...in语句用来遍历一个列表，默认列表是以`空格`、`制表符`、`换行符`作为分隔符，不想被分隔的词可以加上引号。要修改默认分隔符，可以通过修改名为`IFS`的环境变量来完成。

例如下面脚本将把list变量中的每一个单词打印出来：
	
	list="hello world"
	for val in $list ; do
		echo $val
	done
	
或者遍历一条命令的结果：

	for filename in `ls`; do
		echo $filename
	done
	
还可以使用通配符：

	for filename in /tmp/*; do
		echo $filename
	done


**for循环：**

	for (( i = 0; i < 10; i++ )) do
		echo $i
	done


#### 7、while循环

while循环的用法如下：

	var1=10
	while [ $var1 -gt 0 ]; do
		echo $var1
		var1=$[$var1-1]
	done
	
或者定义一个死循环：

	# 每隔60更新更新一下代码
	while :
	do
		git pull
		sleep 10
	done

循环内部也支持使用`break`或`continue`来终止循环或跳过本次循环。

#### 8、函数定义

函数必须先定义后使用，定义函数有2种方式：

	# 定义名为foo的函数
	function foo {
		# 定义局部变量a
		local a=123
		echo "hello"
		
		return 0
	}
	
	# 定义名为bar的函数
	bar() {
		echo "world"
	}
	
函数的调用跟调用命令一样，直接使用函数名即可，不需要加上括号。函数名后面跟着的是传递给函数的参数。使用`return`给函数返回一个退出码，0表示执行成功。退出码的值在0-255之间，大于该值将被截断。如果没有显式返回退出码，bash shell默认将把函数最后一条命令的退出码返回。

如果希望函数返回处理结果，可以使用 `echo` 输出，然后外部使用一个变量接收，例如：

	add() {
		echo $[ $1 + $2 ]
	}

	a=`add 2000 16`

	echo $a
	
#### 9、读取用户输入

read 命令可以用来读取用户的输入并存储到一个变量中，从而实现交互式操作。示例：

	echo -n "请输入你的名字："
	read name
	echo "你好，${name}"
	
注意上面 `echo -n` 的作用是让echo的输出不自动带上换行符。

或者这样：

	read -p "请输入2个数字：" num1 num2
	echo "你输入的数字分别是 ${num1} 和 ${num2}"
	
上面使用 `read -p` 自定义提示符，并且将用户输入分配到两个变量中，用户的输入会以空格或制表符分隔存放到到多个变量中。

使用`read -t`可以指定读取超时时间，例如：

	if read -t 5 -p "请输入你的名字：" name
	then
		echo "你好，$name"
	else
		echo 
		echo "输入时间超出5秒！"
	fi
	
还可以使用 `read -n` 来指定读取字符数，当用户输入达到指定字符数会自动退出。

	while read -n1 -p "确定执行操作吗[Y/N]?：" val
	do
		case $val in
		Y|y)
			echo 
			echo "执行Y操作."
			break
			;;
		N|n)
			echo 
			echo "执行N操作."
			break
			;;
		*)
			echo 
			echo "请输入Y或N";;
		esac
	done
	
可以使用`read -s`来让用户输入不显示在屏幕上，例如密码：

	read -s -p "请输入密码：" password
	echo
	echo "你输入的密码是: $password"
	
	
#### 10、退出程序

在脚本中的任意位置想退出的话，可以使用`exit`关键字。可以带上一个0-255的数字表示退出码，正常退出使用 `exit 0`。如果不指定，则使用最后一条命令的退出码作为当前脚本的退出码。