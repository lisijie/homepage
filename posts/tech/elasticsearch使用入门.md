---
layout: post
title: elasticsearch使用入门
category: 技术
keywords: elasticsearch
date: 2016-03-16
author: 李思杰
---

## 1、概念

**基本概念：**

- 索引（index）：相当于关系型数据库中的数据库。
- 类型（type）：相当于关系型数据库中的表。
- 文档（document）：相当于关系型数据库中的表记录。

**文档（document）**

- 每个文档是一个JSON对象。
- 每个文档有4个基本的元数据：_index、_type、_id、_version，前3个元数据唯一确定一个文档，_version在文档发生变化时加1（包括删除）。
- _id 可以自己定义或者由系统自动生成，自动生成的ID有22个字符，叫UUIDs。
- 删除一个文档不会立即从磁盘删除，而是标记为删除，ES将会在你之后添加更多索引的时候才会在后台进行删除内容的清理

## 2、安装

ES使用Java开发，对JDK版本的要求是1.7以上。

从官方网站 elasticsearch.org/download 下载最新版本，解压到 /data/apps/elasticsearch。
编辑配置文件 config/elasticsearch.yml 修改配置，下面是比较重要的几个配置： 

* cluster.name 集群的名称，ES是一个分布式的搜索引擎，一般都会使用多台机组成一个集群，因此需要设置一个集群名称。
* node.name 节点名称，描述当前节点在集群中的标识，例如：node-1、node-2。不自定义名称的话每次重启都会随机生成一个名称。
* path.data 数据的存放目录，一般都放到一个独立的目录，像mysql一样。
* path.logs 日志目录，一般整个服务器的所有日志都会统一放到一个地方，便于管理。
* network.host 绑定的IP地址

**安装head插件**

	./plugin install mobz/elasticsearch-head

elasticsearch-head是一个elasticsearch的集群管理工具，它是完全由html5编写的独立网页程序，你可以通过插件把它集成到es。

安装完成后可以通过打开http://localhost:9200/_plugin/head/ 访问。

**启动**

执行bin下面的elasticsearch脚本即可。
 
	./bin/elasticsearch 
	
启动，如果要后台启动的话加上 -d 参数。启动完后就可以在浏览器输入 http://localhost:9200/ 访问了。

## 3、集群

- ES使用相同的cluster.name表示同一个集群，一个集群可以由一个节点或多个节点组成，节点可以动态添加或删除，集群会自动推举一个节点为主节点。
- 防止单点故障的方式是增加节点。
- 新加一个节点时，只需在配置文件中指定集群名称，ES会通过广播地址自动发现新节点。
- 当节点数量发生变化时，ES会自动进行数据的重组调节每个节点的分片数量，使得所有节点保持均衡。
- 集群健康度有3种状态：green、yellow、red，跟索引的主分片和复制分片是否可用有关。


## 3、索引

类似使用mysql，在插入记录前我们需要先建库建表。在写入数据到ES前，也需要先创建索引和mapping。虽然ES在写入数据时会自动创建索引和mapping，但是很多时候为了满足业务的需求，需要预先创建好。比如设置某些字段的类型、是否分词、分词器等。一旦某个type下有了数据，要再修改mapping就会比较麻烦。

在ES的配置文件中，可以添加以下配置关闭自动创建索引：
	action.auto_create_index: false

在我最近开发的一个日志统计系统中，我的索引规划如下：

1. 每个月的日志存放到一个索引中，命名为 `logs-201604`
2. 一次性创建一年的索引，也就是 logs-201601 - logs-201612。
3. 针对每种类型写好mapping配置文件，然后再使用put mapping一次性把mapping信息写到所有索引中（index 可以使用通配符 logs-*）。
4. 以后再增加类型，也是按上述方法put mapping。
5. 最后接入使用，写入数据。	
**关于索引的分片：**

- 可以对每个索引指定主分片数量和复制分片数量。默认主分片数量是5。
- 主分片数量关系到数据的最大容量，每个分片承载一部分数据，单个分片容量大小没有限制。但是像关系型数据库一样，一个表的数据量越大查询越慢。
- 复制分片是主分片的一份拷贝，它可以防止硬件故障导致的数据丢失，同时可以提供读请求。
- 当索引创建完成的时候，主分片的数量就固定了，但是复制分片的数量可以随时增加或减少。
- 复制分片可以在主分片发生故障时升级为主分片。

## 4、搜索

### 4.1 简单搜索

### 4.2 filtered搜索

### 4.3 聚合搜索